apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-config
  namespace: observabilidade
  labels:
    app: alertmanager
    managed-by: argocd
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m

    route:
      receiver: slack-default
      group_by: ['alertname', 'namespace', 'severity']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 3h

      routes:
        - match:
            severity: critical
          receiver: telegram-default
          continue: true

    receivers:
      - name: slack-default
        slack_configs:
          - api_url_file: /etc/alertmanager/secrets/alertmanager-slack-webhooks/slack-webhook-geral
            channel: "#alertmanager"
            username: "Alertmanager"
            send_resolved: true
            title: |-
              [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}
            text: |-
              {{ range .Alerts }}
              {{ if eq .Status "firing" }}ğŸ”¥{{ else }}âœ…{{ end }} *{{ .Labels.alertname }}*
              {{- if eq .Labels.severity "critical" }} - ğŸš¨ CRÃTICO{{ end }}
              {{- if eq .Labels.severity "warning" }} - âš ï¸ WARNING{{ end }}
              
              {{- if .Labels.namespace }}
              ğŸ“¦ *Namespace:* `{{ .Labels.namespace }}`{{ end }}
              {{- if .Labels.pod }}
              ğŸ³ *Pod:* `{{ .Labels.pod }}`{{ end }}
              {{- if .Labels.node }}
              ğŸ–¥ï¸ *Node:* `{{ .Labels.node }}`{{ end }}
              {{- if .Labels.instance }}
              ğŸ”— *Instance:* `{{ .Labels.instance }}`{{ end }}
              
              ğŸ“‹ *DescriÃ§Ã£o:*
              {{ .Annotations.description }}
              
              {{- if .Annotations.summary }}
              ğŸ“ *Resumo:* {{ .Annotations.summary }}{{ end }}
              
              â° {{ if eq .Status "firing" }}*InÃ­cio:* {{ .StartsAt.Format "02/01/2006 15:04:05" }}{{ else }}*Resolvido:* {{ .EndsAt.Format "02/01/2006 15:04:05" }}{{ end }}
              â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
              {{ end }}
            color: |-
              {{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}danger{{ else if eq .CommonLabels.severity "warning" }}warning{{ else }}#439FE0{{ end }}{{ else }}good{{ end }}

      - name: telegram-default
        telegram_configs:
          - bot_token_file: /etc/alertmanager/secrets/alertmanager-telegram-chats/telegram-token
            chat_id_file: /etc/alertmanager/secrets/alertmanager-telegram-chats/telegram-chat-id
            send_resolved: true
            parse_mode: HTML
            message: |-
              {{ if eq .Status "firing" }}<b>ğŸ”¥ ALERTA ATIVO</b>{{ else }}<b>âœ… RESOLVIDO</b>{{ end }}
              {{ if gt (len .Alerts.Firing) 0 }}[{{ .Alerts.Firing | len }} alerta(s)]{{ end }}
              
              {{ range .Alerts }}
              â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
              <b>{{ if eq .Labels.severity "critical" }}ğŸš¨{{ else if eq .Labels.severity "warning" }}âš ï¸{{ else }}â„¹ï¸{{ end }} {{ .Labels.alertname }}</b>
              
              {{- if .Labels.namespace }}
              ğŸ“¦ <b>Namespace:</b> <code>{{ .Labels.namespace }}</code>{{ end }}
              {{- if .Labels.pod }}
              ğŸ³ <b>Pod:</b> <code>{{ .Labels.pod }}</code>{{ end }}
              {{- if .Labels.node }}
              ğŸ–¥ï¸ <b>Node:</b> <code>{{ .Labels.node }}</code>{{ end }}
              {{- if .Labels.instance }}
              ğŸ”— <b>Instance:</b> <code>{{ .Labels.instance }}</code>{{ end }}
              
              ğŸ“‹ <b>DescriÃ§Ã£o:</b>
              <i>{{ .Annotations.description }}</i>
              
              {{- if .Annotations.summary }}
              ğŸ“ <b>Resumo:</b> {{ .Annotations.summary }}{{ end }}
              
              â° {{ if eq .Status "firing" }}<b>InÃ­cio:</b> {{ .StartsAt.Format "02/01/06 15:04" }}{{ else }}<b>Resolvido:</b> {{ .EndsAt.Format "02/01/06 15:04" }}{{ end }}
              
              {{ end }}